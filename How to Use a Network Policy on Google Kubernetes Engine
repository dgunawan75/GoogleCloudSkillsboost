
export ZONE=$(gcloud compute project-info describe --format="value(commonInstanceMetadata.items[google-compute-default-zone])")
export REGION=$(echo "$ZONE" | cut -d '-' -f 1-2)
export PROJECT_ID=$(gcloud config get-value project)
export PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format='value(projectNumber)')

gsutil cp -r gs://spls/gsp480/gke-network-policy-demo .
cd gke-network-policy-demo
chmod -R 755 *

gcloud config set compute/region $REGION
gcloud config set compute/zone $ZONE
echo $REGION
echo $ZONE

make setup-project
make tf-apply


gcloud compute ssh gke-demo-bastion


sudo apt-get install google-cloud-sdk-gke-gcloud-auth-plugin

echo "export USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> ~/.bashrc
source ~/.bashrc
export ZONE=$(gcloud compute project-info describe --format="value(commonInstanceMetadata.items[google-compute-default-zone])")
gcloud container clusters get-credentials gke-demo-cluster --zone $ZONE


kubectl apply -f ./manifests/hello-app/
kubectl get pods


kubectl logs --tail 10 -f $(kubectl get pods -oname -l app=hello)
Press CTRL+C to exit.

kubectl logs --tail 10 -f $(kubectl get pods -oname -l app=not-hello)
Press CTRL+C to exit.

kubectl apply -f ./manifests/network-policy.yaml

kubectl logs --tail 10 -f $(kubectl get pods -oname -l app=not-hello)

kubectl delete -f ./manifests/network-policy.yaml
kubectl create -f ./manifests/network-policy-namespaced.yaml
kubectl logs --tail 10 -f $(kubectl get pods -oname -l app=hello)


kubectl -n hello-apps apply -f ./manifests/hello-app/hello-client.yaml
kubectl logs --tail 10 -f -n hello-apps $(kubectl get pods -oname -l app=hello -n hello-apps)

exit

make teardown




